# OurVerse 生产环境设置指南

## 📋 部署前准备清单

### ✅ 已完成的配置

1. **环境配置文件**
   - `.env.example` - 环境变量模板
   - `.env` - 实际配置（已包含默认JWT密钥和高德地图API）

2. **Docker配置**
   - `docker-compose.yml` - 完整的容器编排
   - `Dockerfile` - 应用容器化配置
   - `healthcheck.js` - 健康检查脚本

3. **Nginx配置**
   - `nginx.conf` - 反向代理和静态文件服务

4. **数据库配置**
   - MongoDB 6.0 容器配置
   - 数据库初始化脚本
   - 索引优化配置

5. **部署脚本**
   - `start-production.sh` - 生产环境启动
   - `deploy.sh` - 自动部署脚本

## 🚀 快速开始

### 本地部署（推荐用于测试）

```bash
# 1. 给脚本执行权限
chmod +x deploy.sh start-production.sh

# 2. 运行自动部署
./deploy.sh

# 3. 或直接启动生产环境
./start-production.sh
```

### 手动部署

```bash
# 1. 启动Docker服务
docker-compose up -d --build

# 2. 查看服务状态
docker-compose ps

# 3. 查看日志
docker-compose logs -f
```

## 🔧 配置说明

### 环境变量配置

编辑 `.env` 文件，配置以下重要项：

```env
# 数据库配置
MONGODB_URI=mongodb://mongodb:27017/ourverse

# JWT 密钥（已自动生成）
JWT_SECRET=your-super-secret-jwt-key...

# 高德地图API（已配置）
AMAP_API_KEY=c8cb70e52409857f684c6fb41fc6e7b4

# OAuth配置（需要手动配置）
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
GITHUB_CALLBACK_URL=https://yourdomain.com/api/auth/github/callback
```

### OAuth应用配置

#### GitHub OAuth配置

1. 访问 [GitHub Settings > Developer settings > OAuth Apps](https://github.com/settings/applications/new)
2. 创建新应用：
   - Application name: `OurVerse`
   - Homepage URL: `https://yourdomain.com`
   - Application description: `OurVerse Photo Sharing App`
   - Authorization callback URL: `https://yourdomain.com/api/auth/github/callback`
3. 复制 Client ID 和 Client Secret 到 `.env` 文件

#### 微信OAuth配置（可选）

1. 访问 [微信开放平台](https://open.weixin.qq.com/)
2. 创建网站应用
3. 配置授权回调域名：`yourdomain.com`
4. 复制 AppID 和 AppSecret 到 `.env` 文件

## 🌐 访问地址

部署完成后，可通过以下地址访问：

- **主应用**: `https://localhost`
- **API服务**: `http://localhost:3000`
- **移动端**: `https://[你的IP地址]`

## 🛠️ 管理命令

### 服务管理

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 停止并删除数据
docker-compose down -v

# 重新构建
docker-compose up -d --build
```

### 数据库管理

```bash
# 进入MongoDB容器
docker-compose exec mongodb mongo ourverse

# 备份数据库
docker-compose exec mongodb mongodump --db ourverse --out /data/backup

# 恢复数据库
docker-compose exec mongodb mongorestore --db ourverse /data/backup/ourverse
```

## 🔒 安全配置

### SSL证书配置

当前使用自签名证书。如需真实SSL证书：

1. **使用Let's Encrypt（推荐）**
```bash
# 安装certbot
sudo apt-get install certbot

# 生成证书
sudo certbot certonly --webroot -w /usr/share/nginx/html -d yourdomain.com
```

2. **更新Nginx配置**
```nginx
ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
```

### 防火墙配置

```bash
# 开放端口
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 3000

# 查看状态
sudo ufw status
```

## 📊 监控和日志

### 应用日志

```bash
# 实时查看所有日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f app
docker-compose logs -f nginx
```

### 性能监控

```bash
# 容器资源使用情况
docker stats

# 应用健康检查
curl http://localhost:3000/health
```

## 🔄 升级部署

### 自动升级

```bash
# 拉取最新代码
git pull origin main

# 重新部署
./deploy.sh
```

### 手动升级

```bash
# 停止服务
docker-compose down

# 拉取代码
git pull

# 重建并启动
docker-compose up -d --build
```

## 🐛 故障排除

### 常见问题

1. **端口占用**
```bash
# 检查端口占用
sudo lsof -i :80 -i :443 -i :3000

# 停止占用进程
sudo kill -9 <PID>
```

2. **权限问题**
```bash
# 给脚本执行权限
chmod +x *.sh

# 修复目录权限
sudo chown -R $USER:$USER .
```

3. **内存不足**
```bash
# 增加Docker内存限制
# Docker Desktop -> Settings -> Resources -> Advanced
```

4. **数据库连接失败**
```bash
# 检查MongoDB状态
docker-compose exec mongodb mongo --eval "db.stats()"

# 重启数据库
docker-compose restart mongodb
```

### 调试模式

```bash
# 进入应用容器调试
docker-compose exec app sh

# 查看环境变量
docker-compose exec app env

# 测试数据库连接
docker-compose exec app node -e "require('mongoose').connect(process.env.MONGODB_URI).then(() => console.log('Connected'))"
```

## 📞 技术支持

如遇到问题，请按以下顺序排查：

1. 查看日志：`docker-compose logs -f`
2. 检查服务状态：`docker-compose ps`
3. 验证配置：检查 `.env` 文件
4. 测试网络：`curl http://localhost:3000/health`

## 🎯 下一步计划

### 生产环境优化

1. **配置真实域名和SSL证书**
2. **设置数据库定期备份**
3. **配置日志轮转和监控**
4. **设置负载均衡**
5. **配置CDN加速**

### 功能扩展

1. **添加用户注册和登录页面**
2. **实现照片编辑功能**
3. **添加社交功能**
4. **集成更多地图服务**
5. **添加移动端App**

---

**🎉 恭喜！您的OurVerse应用已成功部署！**

现在您可以开始使用这个基于地理位置的照片分享应用了。记得配置OAuth应用以启用完整的登录功能。
